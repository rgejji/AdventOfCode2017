package main

import (
	"fmt"
	"strings"

	graphutil "github.com/RichardGejji/AdventOfCode2019/GraphUtil"
	simple "gonum.org/v1/gonum/graph/simple"
)

type point struct {
	x int
	y int
}

var grid [][]string

func readGrid() {
	rowSlice := strings.Split(inputStr, "\n")
	grid = [][]string{}
	for _, row := range rowSlice {
		gridRow := []string{}
		for _, val := range row {
			gridRow = append(gridRow, string(val))
		}
		grid = append(grid, gridRow)
	}
}
func cleanupGrid() {
	//Put double letters in same grid
	for i := 1; i < len(grid)-1; i++ {
		for j := 1; j < len(grid[i])-1; j++ {
			//Check if value is an ASCII letter
			if grid[i][j] != "." && grid[i][j] != "#" && grid[i][j] != " " {

				landingPt, nIndex := getLanding(i, j)
				if nIndex < 0 {
					continue
				}

				//Read and clear opposite letter
				oppositePt := point{y: i - (landingPt.y - i), x: j - (landingPt.x - j)}
				oppVal := grid[oppositePt.y][oppositePt.x]
				grid[oppositePt.y][oppositePt.x] = " "
				//Combine opposite letter in grid depending on direction
				if nIndex < 2 {
					grid[i][j] = oppVal + grid[i][j]
				} else {
					grid[i][j] += oppVal
				}
			}
		}

	}
}

//getLanding returns the point of the land and whether it is N,S,W,E using int values 0,1,2,3
func getLanding(i, j int) (point, int) {
	north := point{y: i - 1, x: j}
	south := point{y: i + 1, x: j}
	west := point{y: i, x: j - 1}
	east := point{y: i, x: j + 1}
	nbrs := []point{east, south, north, west}
	nIndex := -1

	//Check we can find a neighbor with a dot
	landingPt := point{}
	for i, p := range nbrs {
		if grid[p.y][p.x] == "." {
			landingPt.x = p.x
			landingPt.y = p.y
			nIndex = i
		}
	}
	return landingPt, nIndex

}

func inGrid(p point) bool {
	val := grid[p.y][p.x]
	if val == " " || val == "#" {
		return false
	}
	return true
}

func printGrid() {
	for i := 0; i < len(grid); i++ {
		for j := 0; j < len(grid[i]); j++ {
			fmt.Printf("%s", string(grid[i][j][0]))
		}
		fmt.Printf("\n")
	}
}

func addPortals(g *simple.UndirectedGraph) {
	prevPortal := make(map[string]point)
	for i := 0; i < len(grid); i++ {
		for j := 0; j < len(grid[i]); j++ {
			portal := grid[i][j]
			if portal == "." || portal == "#" || portal == " " {
				continue
			}

			if pt, ok := prevPortal[portal]; ok {
				//We found matching portals, but we need to link A with B's landing and B with A's landing...
				landingA, _ := getLanding(i, j)
				landingB, _ := getLanding(pt.y, pt.x)
				//portalAID := graphutil.GetID(grid, int64(i), int64(j))
				//portalBID := graphutil.GetID(grid, int64(pt.y), int64(pt.x))
				landingAID := graphutil.GetID(grid, int64(landingA.y), int64(landingA.x))
				landingBID := graphutil.GetID(grid, int64(landingB.y), int64(landingB.x))

				e := g.NewEdge(g.Node(landingAID), g.Node(landingBID))
				g.SetEdge(e)
				//e := g.NewEdge(g.Node(landingAID), g.Node(portalBID))
				//g.SetEdge(e)
				//e = g.NewEdge(g.Node(landingBID), g.Node(portalAID))
				//g.SetEdge(e)
				fmt.Printf("Added portals from %v to (x,y)=(%d,%d)\n", pt, j, i)
			} else {
				prevPortal[portal] = point{x: j, y: i}
			}
		}
	}
}

func getStartAndEnd() (int64, int64) {
	var start, end int64
	for i := 0; i < len(grid); i++ {
		for j := 0; j < len(grid[i]); j++ {
			if grid[i][j] == "AA" {
				start = graphutil.GetID(grid, int64(i), int64(j))
			}
			if grid[i][j] == "ZZ" {
				end = graphutil.GetID(grid, int64(i), int64(j))
			}
		}
	}
	return start, end
}

func main() {
	//Fill out grid
	readGrid()
	cleanupGrid()
	printGrid()
	//Create Grpah
	g := graphutil.GetGraphInvalidList(grid, []string{"#", " "})
	addPortals(g)
	//Find location of AA and ZZ portals.
	//NOTE: Since we start and end in the portals rather than the landings, subtract 2 from the min path result
	startID, endID := getStartAndEnd()
	p := graphutil.GetShortestPath(g, startID, endID)
	fmt.Printf("Have shortest path:\n")
	graphutil.PrintPathCoordinates(grid, p)
	//fmt.Printf("%v\n", g)
	fmt.Printf("Shortest path is length %d.", len(p))
	fmt.Printf("Adjusting for landings and counting number of steps taken is: %d. Done\n", len(p)-3)

}

/*
const inputStr = `                   A
                   A
  #################.#############
  #.#...#...................#.#.#
  #.#.#.###.###.###.#########.#.#
  #.#.#.......#...#.....#.#.#...#
  #.#########.###.#####.#.#.###.#
  #.............#.#.....#.......#
  ###.###########.###.#####.#.#.#
  #.....#        A   C    #.#.#.#
  #######        S   P    #####.#
  #.#...#                 #......VT
  #.#.#.#                 #.#####
  #...#.#               YN....#.#
  #.###.#                 #####.#
DI....#.#                 #.....#
  #####.#                 #.###.#
ZZ......#               QG....#..AS
  ###.###                 #######
JO..#.#.#                 #.....#
  #.#.#.#                 ###.#.#
  #...#..DI             BU....#..LF
  #####.#                 #.#####
YN......#               VT..#....QG
  #.###.#                 #.###.#
  #.#...#                 #.....#
  ###.###    J L     J    #.#.###
  #.....#    O F     P    #.#...#
  #.###.#####.#.#####.#####.###.#
  #...#.#.#...#.....#.....#.#...#
  #.#####.###.###.#.#.#########.#
  #...#.#.....#...#.#.#.#.....#.#
  #.###.#####.###.###.#.#.#######
  #.#.........#...#.............#
  #########.###.###.#############
           B   J   C
           U   P   P               `
*/
/*
const inputStr = `         A
         A
  #######.#########
  #######.........#
  #######.#######.#
  #######.#######.#
  #######.#######.#
  #####  B    ###.#
BC...##  C    ###.#
  ##.##       ###.#
  ##...DE  F  ### #
  #####    G  ###.#
  #########.#####.#
DE..#######...###.#
  #.#########.###.#
FG..#########.....#
  ###########.#####
             Z
             Z       `

*/

const inputStr = `                                           R     L     J           M H         A         Q                                       
                                           E     B     X           T P         B         I                                       
  #########################################.#####.#####.###########.#.#########.#########.#####################################  
  #.#...#...#...#.#...#.....#.#...#.#.#.#.#.#.....#.....#...#.....#.#...#.#.......#.#.........#.....#.#.#.#...#.....#.#.......#  
  #.#.###.#####.#.#.#.#####.#.#.###.#.#.#.#.#.#.#####.###.#.###.#.#.###.#.###.#.###.###.#########.###.#.#.#.###.#####.###.#####  
  #.....#.#.......#.#.#.......#...#.#.......#.#...#.#.#...#...#.#.#.#.....#...#.#.#...............#.#.#.#.....#.#...#.#.#.#...#  
  #.#.###.#######.###.###.#.#.#.###.#.#######.#####.#.#.###.###.#.#.###.#####.###.###.###########.#.#.#.###.###.#.###.#.#.#.###  
  #.#.....#.#.#...#...#...#.#.......#.#.....#.......#.#.#.....#.#.#.#.#.....#.......#...#.#.#...#.......#.....#.#.......#.#.#.#  
  #######.#.#.###.###.#####.#.###.###.#.###.#.#.#####.#.#.#####.#.#.#.###.#########.#.###.#.#.###.###.#######.#.#.###.###.#.#.#  
  #.....#.#...#...#.........#.#.........#.#.#.#...#.....#...#.#.#...#.......#.....#.#.....#...#...#.....#...........#.#.#.....#  
  ###.###.#.#####.#################.#.#.###.#.###########.###.#.#######.#####.###.#.#####.#.#################.#.#.#####.#.#.#.#  
  #...#.#...#.....#...#...#.....#...#.#.#...#.....#.......#.#.#.......#.#...#...#...#.......#...#.#.#...#.....#.#.........#.#.#  
  ###.#.###.#.###.#.#.###.#####.###.#.#####.#.#######.#####.#.###.#####.#.#.###.###.#######.#.###.#.#.###.#.#.#######.#########  
  #.......#.#.#...#.#...#.......#.#.#.#.#...#.#.#...#.....#.....#...#...#.#.#.....#...#.......#.......#...#.#.......#.#.#.....#  
  #.#.#.###.#####.#####.###.###.#.#####.###.#.#.###.#.#######.#.###.#.#.#.#.#.###.#####.#.###.#.###.#.#######.#########.#.#####  
  #.#.#.#.#.#.......#.....#.#.............#.#.....#.......#...#.....#.#.#.#.#.#.#.#...#.#.#...#.#.#.#.#.#.......#.#.#.#...#...#  
  #####.#.#.#####.#.###.#######.#.###.###.#.#.#####.#.#######.#.#.###.###.#.#.#.###.###.#####.#.#.###.#.#######.#.#.#.###.#.###  
  #.........#.#...#...#.......#.#.#...#.....#...#.#.#.....#.#.#.#.#.......#.#.....#.......#.........#.#.#...#.#.....#...#.#...#  
  #########.#.#######.#.###.#####.###.#########.#.###.#####.#.###.###.#.#.#.#.###.###.#.#.#####.#######.#.###.#.#######.#.#.###  
  #.......#.......#...#.#.#...#.#...#.......#.....#.....#...#...#...#.#.#.#.#...#...#.#.#.#.#.#...#.#...#.#.#...#...#.......#.#  
  #####.#######.###.#####.#.#.#.#######.#####.#######.#####.###.###########.#.#######.#####.#.#####.#.###.#.###.###.###.#####.#  
  #.....#...#.........#.#...#...#.#.#.#...#.....#.#.........#...#...#.#.....#.......#...........#.....#...............#.#.#.#.#  
  #####.#.###.#.###.###.#.#####.#.#.#.#.#####.###.#########.#.###.###.###.#########.###.#########.###.###.#####.###.###.#.#.#.#  
  #.#...#.#.#.#...#.....#.#.#.#...#.......#...#.....#.......#.....#.#...#...#.......#.....#...#...#.#.#.#.#...#.#.#.#.....#.#.#  
  #.###.#.#.#######.#.#####.#.#.#####.#####.#.#.#.###.#########.###.###.###.#.###.#.#.#.###.#####.#.#.#.###.###.#.#####.#.#.#.#  
  #.#.#.#.#.#.#.#...#.#.#.#.....#...#...#...#...#.#.........#...#...#...#.#.#...#.#.#.#.......#...#.#.#.#.....#...#.#...#.#.#.#  
  #.#.#.#.#.#.#.#####.#.#.#####.###.#.###.#.#####.#########.#.###.#####.#.#.###.#.###.###########.#.###.###.#.#.###.#.#.###.#.#  
  #...#.#...#...#.#.#...#.........#.....#.#.#.......#.....#.#.#.....#.....#.#...#.#.......#...#.#.....#.#...#.#.......#...#...#  
  #.###.#.#####.#.#.#.###.#####.#####.#######.###.###.#.###.#.#.###.###.#.#.#.#######.#######.#.#.#####.###.#.###.#########.###  
  #...#...#.#...........#.#...#.#.........#.#.#.....#.#.....#.#.#.#...#.#...#.#.....#.......#.#...........#.#.......#.#.#.....#  
  ###.###.#.#######.#.#####.#.#.#####.###.#.#######.#.#######.#.#.#.###.#####.#.###.###.#.###.#.###.#.###.###.###.###.#.###.###  
  #.......#.#.#.#...#...#...#.......#...#...#...#...#...#.#.....#...#.....#.....#.#...#.#.........#.#.#.....#.#.#.#.#.#.#.#...#  
  #######.#.#.#.#####.#.#####.#.#.###.#########.#.###.###.###.###.#######.#######.#.#######.###.#.#############.#.#.#.#.#.#.###  
  #.#.........#.#.#...#.#...#.#.#.........#.........#.......#...#.....#...#...........#.....#...#.#.....#...#...#...#...#.#.#.#  
  #.#.#####.###.#.###.#####.#####.#####.###########.#####.#########.###.#####.###########.#########.#.###.#.###.#.###.###.#.#.#  
  #...#...#.#...#.........#.#.#...#    U           J     B         J   C     L           W    #.#...#.#.#.#.#.......#.#.#.....#  
  ###.#.#######.###.#.#####.#.###.#    X           K     K         X   M     B           A    #.#.#####.###.#####.###.#.###.###  
  #...#...#.........#.#.#.#...#...#                                                           #...........#...#...#.......#...#  
  ###.#.#############.#.#.###.#####                                                           #.###.###.#.#.#.#.#.#.###.#.#.#.#  
  #.#.......#...........#.........#                                                         EV..#...#.#.#...#...#.#.#.#.#...#..OS
  #.###.#.#####.#####.#.#.#.###.#.#                                                           #.#.#.#.#.#.#######.#.#.#####.#.#  
ZL..#...#...#.......#.#...#...#.#.#                                                           #.#.#...#.#.#.#...........#...#.#  
  #.#.#.###.#####.#.###.#.#.###.###                                                           #.###########.#########.#########  
  #...#.#.......#.#.#.#.#.#.#......HP                                                         #...#...........#.....#.#.#...#.#  
  #############.#.###.#########.#.#                                                           ###.###.#######.#.#.#####.#.#.#.#  
  #...#...#.......#.#.#.#.#...#.#.#                                                           #.#.#...#...#.....#.....#...#.#..TG
  #.###.#####.#####.#.#.#.###.#####                                                           #.#####.#.#.#####.#####.###.###.#  
  #.......#...#...................#                                                         QI......#...#...#.#.#.....#.....#.#  
  #.###.#####.###.###.#.###.#.#.###                                                           #.###.###.#####.#####.###.###.#.#  
  #...#.....#.#.....#.#.#...#.#....SL                                                         #...#.....#...#.#...........#...#  
  ###.#.#######.###.###.#####.#.#.#                                                           ###########.###.#################  
CM....#.#.........#...#...#.#.#.#.#                                                           #.........#.....#.......#.#.....#  
  ###.#.###.###############.#######                                                           ###.###.###.###.#.###.#.#.#.#.###  
  #...#.......#.....#.#.#.....#...#                                                           #.#.#.#...#...#.....#.#...#.#....SL
  ###############.###.#.#.#.#####.#                                                           #.#.#.#.#####.#######.###.#.#####  
  #.#.#...............#...#.#.#...#                                                           #.....#.....#.....#.....#...#.#.#  
  #.#.#.#####.#.#.#.#####.###.#.###                                                           #####.#####.#.#####.#######.#.#.#  
  #.......#.#.#.#.#.#.#.....#.#...#                                                         FE......#.......#...#.#...#.#.#.#.#  
  #.#######.###.###.#.#####.#.#.#.#                                                           #################.###.###.###.#.#  
WF....#...#.#.....#.#...#...#.#.#..MK                                                         #...#.#.........................#  
  #####.###.###.#.#####.#.#.#.###.#                                                           #.###.#.#####.###.###.#.#.###.#.#  
  #.........#...#.........#.......#                                                           #...#.#.....#...#.#.#.#.#.#...#.#  
  #####.#.#####.#####.###.#######.#                                                           #.###.#.#.###.###.#.###.#####.#.#  
  #.....#.....#.#.....#.#.#.......#                                                         AT....#...#...#.#...#...#.#.#.#.#..JK
  #.###.#######.#.#.###.#.#####.#.#                                                           #.###.#.###########.###.#.#.#####  
  #.#.....#...#.#.#...#...#.#.#.#.#                                                           #.....#.......#.....#.#.#...#...#  
  #.#.###.#.#############.#.#.#####                                                           #####.#########.###.#.#####.#.###  
FE..#.#...#...#...#.#.#.#.#.#.#....BR                                                         #...#.....#.#.#.#.....#...#.....#  
  #####.#####.#.###.#.#.###.#.###.#                                                           #.#########.#.#####.###.###.#.###  
  #.#.............................#                                                         OS......#.#.#...#.#.#.#.#.....#...#  
  #.###.#.#.###.#.#.###.#######.###                                                           ###.###.#.###.#.#.#.#.###.###.###  
  #.#...#.#.#...#.#.#.#.#.....#.#..UU                                                         #...........#.#.#.........#...#..WA
  #.###.###.#####.###.#####.#.###.#                                                           #####.###.###.#.#.#.#.#######.#.#  
BK..#.....#.....#...#...#.#.#.#...#                                                           #.#...#.#.........#.#.#...#.#...#  
  #.#################.###.#.#.###.#                                                           #.#####.#################.#.#####  
  #.#...#.#.#.............#.#.....#                                                         TG......#...#...........#.......#..OJ
  #.###.#.#.#####.#####.#.#.#.###.#                                                           ###.#.#.#.#.#####.#.#.#.#.#####.#  
MK..................#.#.#...#.#....AB                                                         #...#...#...#...#.#.#...#.....#.#  
  #######.#.#.#.#.###.###########.#                                                           ###########.###.#####.#######.#.#  
  #.....#.#.#.#.#.#.#.........#.#.#                                                           #.#.#.#.......#.#...#.#.#.#.....#  
  #.###.###########.###.###.#.#.###                                                           #.#.#.#########.###.###.#.#####.#  
  #.#.#.....#.#...#.#.....#.#.#.#.#                                                         EN........#...#...#.............#.#  
  #.#.#.#####.###.#.#####.###.#.#.#                                                           #.###.#####.#.#.#.###.#######.###  
  #...#.#.#.......#...#...#.#.#.#..FD                                                         #...#.....#...#.....#.#.....#.#..UX
  ###.#.#.#.#.#.###.#.#.###.#.#.#.#                                                           #.###.#.#.#.#.#.#.#.###.###.#.#.#  
EN....#.....#.#.....#.....#.......#                                                           #.#.#.#.#...#.#.#.#...#...#...#.#  
  #.#####.#.#####.#.#####.#.#.###.#                                                           ###.#.#####.###.###.#####.#####.#  
  #.....#.#.....#.#.#...#.#.#...#.#                                                           #.......#...#...#.....#.........#  
  #.#######.#####.#.###.#####.###.#            M   O           X     W         R     Z        ###.#####.#.###.###.#.#.###.#.###  
  #.#.....#.....#.#.......#.....#.#            T   J           H     F         E     L        #.....#...#...#.#...#.#.#.#.#...#  
  #.#.#####.#########.#####.###.###############.###.###########.#####.#########.#####.#################.#.###.#####.#.#.#.#.#.#  
  #...#.......#.........#...#.....#.....#.........#.....#.....#.#.......#.......#...#...........#.#.....#.#.#.....#.#...#.#.#.#  
  #.###.#.#.#####.#.#.###.#.#####.###.#.#.#####.#######.#.###.#.#.#######.#######.#.###.###.#####.#########.#.#.#######.#.###.#  
  #.#...#.#...#...#.#...#.#.....#.#.#.#.#.#.....#...#...#.#.....#.....#.........#.#.......#.....#...#.#.......#.......#.#...#.#  
  #.#.#####.#.#.#####.#####.#######.#.#########.#.###.###.###########.#####.###.#.###########.###.###.###.#.#.###.###.###.###.#  
  #.#.....#.#.#.#.........#...#...#.#.#.#...#...#.......#.........#.#...#.#.#...#.....#.#.#...#.#.#.#.....#.#.#.....#...#.#.#.#  
  #.###.###########.#.#.#########.#.#.#.#.#####.#.###.#####.#.#.###.###.#.#####.#.#.#.#.#.#####.#.#.#####.###.#.#.#.###.###.###  
  #...#...#...#.....#.#.#.#.........#.#.#.#.....#...#.....#.#.#.....#.....#.....#.#.#...#...........#.#...#...#.#.#.#.......#.#  
  #.#.#.#####.#.###.#####.#.#######.#.#.#.#####.#.#############.#.###.###.###.#######.#.#.#######.###.#.#.###.#.#.###.#####.#.#  
  #.#.#...#.#...#...#.#...#.#...................#.....#.#.#.#...#.#.....#.#...#.#...#.#.........#.....#.#.#...#.#...#...#.....#  
  ###.#####.#.#####.#.###.#####.#####.###.#####.#####.#.#.#.###.#.#.###.###.#.#.#.#####.###.#.#####.#.#.#.#.#.###.#####.#####.#  
  #...#.......#.........#.....#.#.....#.#...#...#.......#.......#.#.#.....#.#.....#.#.....#.#...#...#.#.#.#.#.#.......#...#.#.#  
  #####.###.###.###.#.#.#####.#########.###.#.#####.###.#####.###.###.###.#####.###.#.#.#.#.#.#.###.#####.#.###.#######.#.#.#.#  
  #.#...#.....#.#.#.#.#.#...#...#...#.......#.#...#.#.....#.#...#.#.....#.#.#...#...#.#.#.#.#.#.#.......#.#.#.....#.....#.#...#  
  #.#.#####.#.###.#.#.###.#.#.###.###.###.#.#####.#####.###.#.#####.#.#####.#.#.#.#####.###.#.#####.###.###.###.#.#########.#.#  
  #.....#...#.#.....#.#...#.........#.#...#...#...#.......#.#.....#.#.#.....#.#.....#...#.#.#...#.#.#...#.....#.#.......#...#.#  
  ###.#.###.#####.#.###############.#####.#######.###.#.###.###.#####.#####.###.#######.#.#.###.#.#########.#.###.#.#####.#.#.#  
  #...#.#.....#...#.#.....................#...#.#.#...#.#.....#.....#...#.......#...#.....#.#.#.....#.#.#...#.#.#.#...#...#.#.#  
  #.#.#####.#########.###.#.#####.#####.#.###.#.#.#####.#.#.###.###.###.###.#####.#####.#####.#.#####.#.#.#.###.#.#.###.#.###.#  
  #.#...#.........#...#.#.#.#.........#.#...#...#...#.#.#.#.#.....#.#.....#.......#.#.....#.#...#.#.#...#.#.....#.#...#.#.#...#  
  #####.#####.#.###.###.#########.#######.#.###.#.#.#.#.#.#.#.#.#.#####.###.###.#.#.###.###.#####.#.#.#.###.#.###.#.#.#.#.###.#  
  #.#...#.....#.#.#...#...#.......#.......#.#.....#.#.#.#.#...#.#.#.#...#...#...#.#...........#.#.#...#...#.#...#.#.#.#.#...#.#  
  #.#.#######.###.#####.###.###.#.#####.#.#######.#.###.#.#.#######.###.#######.#.#####.#.###.#.#.#.#############.#.#####.###.#  
  #.....#.......#...........#...#.#...#.#...#.#...#.....#.#...#.........#...#.#.#...#...#...#.............#.#.#.#.#...#.....#.#  
  #.#.#######.###.#.###.#.###.#.#####.#.#.#.#.###.#######.###.#.#######.#.###.#.#####.#.#########.###.###.#.#.#.###.#.#.#.#.###  
  #.#.#.........#.#.#...#.#...#.#...#.#.#.#.#.#...#...#.....#.#.#.#.........#.....#...#.........#...#...#.......#...#.#.#.#...#  
  #.#.#####.###.###.###.###.#.#####.#.###.###.###.#.#.#####.#####.#####.#######.###.###.###.#####.#####.#.###########.#.###.###  
  #.#.#.......#.#.#.#.....#.#...#.............#.....#.#.......#.#.#.....#...#.....#.#...#.......#.....#.#.........#...#.#.#...#  
  ###.#####.#.#.#.#####.###.#######.###.#####.###.###.###.#####.#.#####.#.###.#.#######.#####.#####.#########.###########.#.#.#  
  #...#.....#.#.#.........#.#.....#.#.....#.....#.#.....#.........#.#.#.....#.#.....#.#...#.....#...........#.......#.......#.#  
  #.#.#####.#####.#.#.#.#.#######.#####.#######.#######.#######.###.#.#.#######.#####.#.#####.###.###.#####.#.#######.#####.###  
  #.#.#.....#.....#.#.#.#.#.............#.........#.......#.....#.......#...........#.....#...#...#.......#.#.......#.#.......#  
  #########################################.###.###.###.###.#####.#########.#########.#########################################  
                                           X   A   B   Z   A     F         E         U                                           
                                           H   A   R   Z   T     D         V         U                                           `
